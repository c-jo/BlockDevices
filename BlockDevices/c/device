/*******************************************************************
 * File:        device
 * Purpose:     Management of a single device and its interfaces
 * Author:      Chris Johns
 ******************************************************************/

#include <stdlib.h>
#include <string.h>

#include "callx.h"
#include "fortify.h"

/* #include "BlockDevices.h" */
#include "device.h"
#include "str.h"

#include <stdio.h>

/*******************************************************************
 Function:      device_create
 Description:   Create a reference to a device
 Parameters:    location_id = location of the device
                capabilities = capabilities flags
                provider -> provider name (will be copied)
                driver_code -> the code to call for the driver
                driver_ws -> r12 value for the driver
 Returns:       pointer to the device_t, or NULL if failed
 ******************************************************************/
device_t *device_create(
              device_info_t * info,
              void *          driver_code,
              void *          driver_ws)
{
    device_t *device;

    device = calloc(1, sizeof(*device));
    if (device == NULL)
        goto failed;

    /* Copy the fields to our device information block */
    device->info.device_flags        = info->device_flags;
    device->info.interface_type      = info->interface_type;
    device->info.media_type          = info->media_type;
    device->info.parent_device       = info->parent_device;
    device->info.partition_scheme    = info->partition_scheme;
    device->info.partition_index     = info->partition_index;
    device->info.partition_type      = info->partition_type;
    device->info.block_count         = info->block_count;
    device->info.block_size          = info->block_size;

    device->info.manufacturer        = info->manufacturer ? strdup(info->manufacturer) : NULL;
    device->info.product             = info->product ? strdup(info->product) : NULL;
    device->info.serial              = info->serial ? strdup(info->serial) : NULL;
    device->info.firmware            = info->firmware ? strdup(info->firmware) : NULL;

    device->driver_code = driver_code;
    device->driver_ws = driver_ws;

    return device;

failed:
    if (device)
    {
        free(device->info.manufacturer);
        free(device->info.product);
        free(device->info.serial);
        free(device->info.firmware);
        free(device);
    }
    return NULL;
}

/*******************************************************************
 Function:      device_destroy
 Description:   Destroy the device
 Parameters:    device-> the device we're destroying (assumed to already have
                      been unlinked).
 Returns:       none
 ******************************************************************/
void device_destroy(device_t *device)
{
    if (device)
    {
        free(device->info.manufacturer);
        device->info.manufacturer = NULL;
        free(device->info.product);
        device->info.product = NULL;
        free(device->info.serial);
        device->info.serial = NULL;
        free(device->info.firmware);
        device->info.firmware = NULL;
        free(device);
    }
}


/*******************************************************************
 Function:      device_read
 Description:   Read data from a device.
 Parameters:    device -> the device to read from
                flags = read flags
                block -> transfer block
 Returns:       pointer to an error block if failed
                NULL if successful
 ******************************************************************/
_kernel_oserror * device_read(device_t *device, unsigned long flags, transfer_block_t *block)
{
    return _callx(device->driver_code, device->driver_ws,
                 _INR(0, 3),
                 1, device->device_id, flags, block);
}


/*******************************************************************
 Function:      device_write
 Description:   Write data to a device.
 Parameters:    device -> the device to write to
                flags = read flags
                block -> transfer block
 Returns:       pointer to an error block if failed
                NULL if successful
 ******************************************************************/
_kernel_oserror * device_write(device_t *device, unsigned long flags, transfer_block_t *block)
{
    return _callx(device->driver_code, device->driver_ws,
                 _INR(0, 3),
                 2, device->device_id, flags, block);
}
