%YAML 1.0
---

# RISC OS build file to execute on https://build.riscos.online/

# Source is optional (NYI), and should be a URL to source the content from
#source: <url>

# Defines a list of jobs which will be performed.
# Only 1 job will currently be executed.
jobs:
  build:
    # Env defines system variables which will be used within the environment.
    # Multiple variables may be assigned.
    env:
      "Sys$Environment": ROBuild
      "BUILD32": 1

      # Faster building using the host toolchain
      "Alias$AMU": "HostAMU %*0"

    # Directory to change to before running script
    #dir: <working directory>

    # Commands which should be executed to perform the build.
    # The build will terminate if any command returns a non-0 return code or an error.
    script:

      # Header export
      - echo
      - echo *** Build the exports ***
      - amu -f MakefilePyro export

      # Build modules
      - echo
      - echo *** Build the RAM module (32-bit) ***
      - amu -f MakefilePyro ram

      - echo
      - echo *** Build the RAM module (26-bit) ***
      - amu -f MakefilePyro ram BUILD26=1 BUILD32=

      - echo
      - echo *** Load the module ***
      - RMLoad rm32.BlockDevices

      # Simple tests
      - echo *** Test BlockDevices command ***
      - BlockDevices
      - echo *** Killing the module should be safe ***
      - RMKill BlockDevices

      # Build modules for ROM
      - echo
      - echo *** Build the ROM module (32-bit) ***
      - amu -f MakefilePyro rom

      - echo
      - echo *** Build the ROM module (26-bit) ***
      - amu -f MakefilePyro rom BUILD26=1 BUILD32=

      - echo *** Copy artifacts ***
      - cdir Artifacts
      - copy rm32.BlockDevices Artifacts.* ~CV
      - copy rm.BlockDevices Artifacts.* ~CV
      - copy aof32.BlockDevices Artifacts.* ~CV
      - copy aof.BlockDevices Artifacts.* ~CV
      - cdir Artifacts.Lib
      - cdir Artifacts.Lib.h
      - copy <Exports$Dir>.C.h.BlockDevices Artifacts.Lib.h.BlockDevices ~CV
      - copy LICENSE Artifacts.* ~CV

      - echo
      - echo *** SUCCESS ***

    # Outputs from the build are defined in artifacts
    # These are a list of artifacts to report directories or files.
    # Only a single item is currently supported.
    artifacts:
      # Each element of the artifacts should have a path key, which gives the file or
      # directory to return.
      - path: Artifacts
